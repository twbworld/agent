<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品详情页</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f9;
    }

    .product-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      width: 350px;
      text-align: center;
    }

    .product-card img {
      width: 100%;
      height: auto;
    }

    .product-card h1 {
      font-size: 1.5em;
      margin: 0.8em 0;
    }

    .product-card div {
      color: #e44d26;
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 1em;
    }

  </style>
</head>

<body>

  <div class="product-card">
    <img id="goods_image"
      src="https://wjyqtj.oss-cn-guangzhou.aliyuncs.com/temp/f966babe-031c-4ef7-b29f-ff4d56f5d897.png" alt="商品图片">
    <h1 id="goods_title">Qwen3-72B 限量版纪念T恤</h1>
    <div id="price">¥199.00</div>
    <p>点击右下角聊天框，咨询此商品</p>

    <span id="goods_id" style="display: none;">663</span>
    <span id="order_id" style="display: none;">777</span>
  </div>


  <script>
    // ========== uni-app 通信部分 ==========
    
    // 发送消息到uni-app的通用方法
    function sendMessage(type, data) {
      const message = {
        type: type,
        data: data,
        timestamp: Date.now()
      };
      
      // H5环境使用postMessage
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(JSON.stringify(message), '*');
        console.log('已发送消息到uni-app:', type);
      }
      
      // App环境使用uni.postMessage
      if (typeof uni !== 'undefined' && uni.postMessage) {
        uni.postMessage({ data: message });
        console.log('已发送消息到uni-app:', type);
      }
    }

    // 监听来自uni-app的消息
    window.onUniAppMessage = function(message) {
      console.log('收到uni-app消息:', message);
      
      // 根据消息类型处理不同的操作
      switch (message.type) {
        case 'init':
          console.log('收到初始化消息:', message.data);
          break;
          
        case 'user_info_response':
          if (message.data.success) {
            console.log('收到用户信息:', message.data.data);
            // 使用接收到的用户信息更新Chatwoot
            if (window.$chatwoot && message.data.data) {
              const userInfo = message.data.data;
              window.$chatwoot.setUser(userInfo.id || userInfo.userId, {
                name: userInfo.nickname || userInfo.userName,
                avatar_url: userInfo.avatar,
                email: userInfo.email
              });
            }
          }
          break;
          
        // 可以添加更多消息类型的处理
        default:
          console.log('收到未处理的消息类型:', message.type);
          break;
      }
    };

    // 页面加载完成后发送ready消息给uni-app
    window.addEventListener('load', function() {
      setTimeout(function() {
        // 通知uni-app页面已准备就绪
        sendMessage('ready', {
          url: window.location.href,
          title: document.title,
          goodsId: document.getElementById('goods_id').innerText,
          orderId: document.getElementById('order_id').innerText
        });
      }, 500);
    });

    // 示例：发送商品信息给uni-app
    function sendProductInfo() {
      sendMessage('product_info', {
        goods_id: document.getElementById('goods_id').innerText,
        goods_title: document.getElementById('goods_title').innerText,
        goods_image: document.getElementById('goods_image').src,
        price: document.getElementById('price').innerText
      });
    }

    // 请求用户信息
    function requestUserInfo() {
      sendMessage('user_info');
    }

    // ========== Chatwoot SDK 部分 ==========
    
    (function (d, t) {
      var BASE_URL = "http://192.168.3.111:3000";
      var WEBSITE_TOKEN = '7Lwg9fZnczpy18q8ZqvPfW1V';

      var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
      g.src = BASE_URL + "/packs/js/sdk.js";
      // g.src = 'http://192.168.3.84:8081/exportsdk.js'
      g.async = true;
      s.parentNode.insertBefore(g, s);

      g.onload = function () {
        try {
          // --- 准备商品信息 ---
          const goodsInfo = {
            goods_id: document.getElementById('goods_id').innerText,
            goods_title: document.getElementById('goods_title').innerText,
            goods_image: document.getElementById('goods_image').src,
            goods_price: document.getElementById('price').innerText,
            goods_url: window.location.href
          };

          // --- 关键修改：监听 chatwoot:ready 事件 ---
          window.addEventListener('chatwoot:ready', function () {
            // 1. 获取用户信息 (读取或写入)
            // 准备用户信息 (逻辑与之前相同)
            let userId;
            let userName;
            let avatarUrl;

            // let loginUserId = localStorage.getItem('user_id');
            let loginUserId = "22334";
            // 只有 ID 为 22334 时，这个 hash 才是有效的, userHash需要请求后端获取, 这只为了测试而硬编码
            let userHash = "f5fabd53697045e98ab77f8c07fc76b175fe6b50f136d621889191c15cb8ead7";

            if (loginUserId) {
              userId = loginUserId;
              userName = localStorage.getItem('user_name') || `用户 ${userId}`;
              avatarUrl = localStorage.getItem('avatar_url') || `${window.location.origin}/favicon.ico`;
            } else {
              userId = `visitor-${Date.now()}${Math.floor(100000 + Math.random() * 900000)}`;
              userName = `访客-${userId.slice(-6)}`;
              avatarUrl = `${window.location.origin}/favicon.ico`;
              localStorage.setItem('user_id', userId);
              localStorage.setItem('user_name', userName);
              localStorage.setItem('avatar_url', avatarUrl);
            }

            // 2. 构造 setUser 对象
            const userConfig = {
              name: userName,
              avatar_url: avatarUrl,
            };

            // ⚠️ 极其重要：
            // identifier_hash 必须传且必须正确。
            // 如果是随机生成的访客ID，通常不要传错误的 hash，否则会被拒绝连接。
            if (userHash) {
              userConfig.identifier_hash = userHash;
            }

            // 3. 设置用户唯一标识 (找回历史记录的核心)
            window.$chatwoot.setUser(userId, userConfig);

            // 4. 设置商品自定义属性
            window.$chatwoot.setCustomAttributes(goodsInfo);
            
            // 通知uni-app Chatwoot已准备就绪
            sendMessage('chatwoot_ready', goodsInfo);
          });

          // --- SDK 启动 (只负责配置) ---
          window.chatwootSDK.run({
            websiteToken: WEBSITE_TOKEN,
            baseUrl: BASE_URL
          });

        } catch (error) {
          console.error('配置 Chatwoot SDK 失败:', error);
        }
      }
    })(document, "script");
  </script>
</body>

</html>
