<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI å®¢æœçŸ¥è¯†åº“</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

  <div x-data="kbApp()" x-init="initData()" class="w-full lg:w-[90%] xl:w-[80%] mx-auto p-6 pb-24">

    <div class="sticky top-4 z-40 bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-6 flex justify-between items-center gap-4">

      <!-- å·¦ä¾§: æœç´¢æ  + åˆ†é¡µ -->
      <div class="flex-1 flex gap-4 items-center max-w-xl z-10">
        <!-- æœç´¢æ¡†å®¹å™¨ -->
        <div class="relative group">
          <!-- ä¿®æ”¹: å¢åŠ åˆ¤æ–­ searchQuery ? 'w-64' å®ç°æœ‰å†…å®¹æ—¶ä¿æŒå±•å¼€ -->
          <input type="text" x-model.debounce.300ms="searchQuery"
            :disabled="isEditingMode"
            :class="searchQuery ? 'w-64' : (totalPages > 1 ? 'w-12' : 'w-20')"
            class="disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 focus:w-64 transition-all duration-300 ease-in-out pl-10 pr-8 py-2 border rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none text-sm">

          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>

          <!-- æ¸…ç©ºæŒ‰é’® -->
          <button x-show="searchQuery"
            @click="searchQuery = ''"
            @mousedown.prevent
            :disabled="isEditingMode"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 scale-90"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-100"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-90"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 focus:outline-none transition-colors disabled:opacity-0 disabled:pointer-events-none"
            title="æ¸…ç©º">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- ä¿®æ”¹: ç§»é™¤ x-show="totalPages > 1" ä»¥å§‹ç»ˆæ˜¾ç¤ºæ¡æ•° -->
        <div class="text-xs text-gray-600 flex gap-2 items-center whitespace-nowrap">
          <span x-text="`å…± ${filteredItems.length} æ¡`"></span>
          <!-- å½“åªæœ‰ä¸€é¡µæ—¶éšè—ç¿»é¡µæŒ‰é’®, ä¿æŒç•Œé¢æ•´æ´, æˆ–æ ¹æ®éœ€æ±‚ç§»é™¤ x-show å§‹ç»ˆæ˜¾ç¤ºç¦ç”¨çŠ¶æ€çš„æŒ‰é’® -->
          <div class="flex gap-2 items-center" x-show="totalPages > 1">
            <button @click="prevPage" :disabled="page === 1" class="disabled:opacity-30 hover:text-indigo-600 px-1 font-bold">â—€</button>
            <span x-text="`${page}/${totalPages || 1}`"></span>
            <button @click="nextPage" :disabled="page === totalPages" class="disabled:opacity-30 hover:text-indigo-600 px-1 font-bold">â–¶</button>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´: æ ‡é¢˜ -->
      <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none">
        <h1 class="text-xl font-bold text-indigo-600 whitespace-nowrap">AI å®¢æœçŸ¥è¯†åº“</h1>
      </div>

      <!-- å³ä¾§: æŒ‰é’®ç»„ -->
      <div class="flex gap-3 justify-end items-center z-10" :class="{'opacity-50 pointer-events-none': isEditingMode}">
        <button @click="forceSync()" :disabled="loading"
          class="group relative w-9 h-9 flex items-center justify-center bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 hover:shadow-md rounded-full shadow-sm transition disabled:opacity-50">
          <svg x-show="loading" class="animate-spin h-4 w-4 absolute" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <svg x-show="!loading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span class="absolute top-full mt-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">å¼ºåˆ¶ç«‹å³ç”Ÿæ•ˆ</span>
        </button>

        <button @click="createNew()"
          class="group relative w-9 h-9 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-md transition hover:scale-105">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="absolute top-full mt-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">æ–°å¢</span>
        </button>
      </div>

    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <div class="space-y-4 relative z-0">

      <!-- æ–°å¢æ¡ç›®å®¹å™¨ -->
      <template x-if="newItem">
        <div class="bg-white rounded-lg shadow-xl border-2 border-indigo-500 p-6 relative mb-6 ring-4 ring-indigo-50">
          <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-100">
            <h3 class="font-bold text-lg text-indigo-900 flex items-center gap-2"><span>ğŸ†•</span> æ–°å¢</h3>
          </div>

          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">å›å¤å†…å®¹ (çŸ¥è¯†åº“ç­”æ¡ˆ)</label>
              <textarea x-model="newItem.editBuffer.answer" rows="5" placeholder="æ”¯æŒ markdown è¯­æ³•"
                class="w-full p-3 border rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 text-sm transition-colors"></textarea>
            </div>

            <div>
              <div class="relative flex items-center justify-between mb-2 h-8">
                <span class="text-xs text-gray-400 font-mono">
                  (<span x-text="newItem.editBuffer.questions.length"></span>/<span x-text="maxQuestions"></span>)
                </span>
                <label class="absolute left-1/2 -translate-x-1/2 text-xs font-bold text-gray-500 uppercase">å…³è”é—®é¢˜</label>
                <button @click="generateQuestions(newItem.editBuffer)"
                  x-show="newItem.editBuffer.answer.trim()"
                  :disabled="newItem.editBuffer.questions.length >= maxQuestions || loading"
                  class="group relative text-xs bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-100 flex items-center gap-1 disabled:opacity-50 transition-colors">
                  <span>âœ¨</span>
                  <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">AI ç”Ÿæˆæé—®</span>
                </button>
              </div>

              <div class="space-y-3">
                <template x-for="(q, qIdx) in newItem.editBuffer.questions" :key="qIdx">
                  <div class="flex gap-2 items-center">
                    <div x-data="{ open: false }" class="relative w-32 shrink-0" :class="open ? 'z-[100]' : 'z-10'">
                      <button @click="open = !open" @click.outside="open = false" type="button"
                        class="w-full flex justify-between items-center px-3 py-2 text-xs border rounded shadow-sm transition-colors focus:outline-none bg-white"
                        :class="{
                                    'text-violet-700 border-violet-200 bg-violet-50': q.type === 'AI_SEMANTIC',
                                    'text-blue-700 border-blue-200 bg-blue-50': q.type === 'EXACT',
                                    'text-cyan-700 border-cyan-200 bg-cyan-50': q.type === 'HYBRID'
                                }">
                        <span x-text="q.type === 'AI_SEMANTIC' ? 'AI è¯­ä¹‰' : (q.type === 'HYBRID' ? 'æ··åˆ' : 'ç²¾ç¡®åŒ¹é…')"></span>
                        <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div x-show="open" class="absolute top-full left-0 mt-1 w-full bg-white border border-gray-200 rounded shadow-xl overflow-hidden">
                        <div @click="q.type='AI_SEMANTIC'; open=false" class="px-3 py-2 text-xs hover:bg-violet-50 cursor-pointer text-violet-700 border-l-4 border-transparent hover:border-violet-500">AI è¯­ä¹‰</div>
                        <div @click="q.type='EXACT'; open=false" class="px-3 py-2 text-xs hover:bg-blue-50 cursor-pointer text-blue-700 border-l-4 border-transparent hover:border-blue-500">ç²¾ç¡®åŒ¹é…</div>
                        <div @click="q.type='HYBRID'; open=false" class="px-3 py-2 text-xs hover:bg-cyan-50 cursor-pointer text-cyan-700 border-l-4 border-transparent hover:border-cyan-500">æ··åˆ(è¯­ä¹‰+ç²¾ç¡®)</div>
                      </div>
                    </div>

                    <div class="relative flex-1">
                      <input type="text" x-model="q.question"
                        class="w-full p-2 pr-20 text-sm border border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                        placeholder="è¾“å…¥ç”¨æˆ·å¯èƒ½é—®çš„é—®é¢˜...">

                      <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1">
                        <button @click="extendQuestion(newItem.editBuffer, qIdx)"
                          x-show="q.question.trim()"
                          class="group relative w-7 h-7 flex items-center justify-center text-yellow-600 hover:bg-yellow-50 rounded-full transition">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                          </svg>
                          <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ç”Ÿæˆç›¸ä¼¼æé—®</span>
                        </button>
                        <button @click="removeQuestion(newItem.editBuffer, qIdx)"
                          class="group relative w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                          </svg>
                          <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ç§»é™¤</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div class="relative flex justify-between items-center mt-6 border-t pt-4 border-indigo-100">
               <div></div>
               <div class="absolute left-1/2 -translate-x-1/2">
                 <button @click="addQuestion(newItem.editBuffer)"
                   :disabled="newItem.editBuffer.questions.length >= maxQuestions"
                   class="group relative w-6 h-6 flex items-center justify-center bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white transition disabled:opacity-50 disabled:hover:bg-indigo-100 disabled:hover:text-indigo-600">
                   <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                   </svg>
                   <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">æ·»åŠ å…³è”é—®é¢˜</span>
                 </button>
               </div>

              <div class="flex gap-4">
                <button @click="cancelEdit(newItem)"
                  class="group relative w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-500 rounded-full hover:bg-gray-200 hover:text-gray-700 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">å–æ¶ˆ</span>
                </button>
                <button @click="saveItem(newItem)" :disabled="loading" x-show="hasChanges(newItem)"
                  class="group relative w-10 h-10 flex items-center justify-center bg-green-500 text-white rounded-full hover:bg-green-600 shadow-lg hover:shadow-xl transition transform hover:scale-105 disabled:opacity-50 disabled:scale-100">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ä¿å­˜</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- æ•°æ®åˆ—è¡¨å¾ªç¯ -->
      <template x-for="(item, idx) in pagedItems" :key="item.id">
        <div class="bg-white rounded-lg shadow border border-gray-200 transition hover:shadow-md group/card"
             :class="{'opacity-60 cursor-not-allowed': isEditingMode && !item.isEditing}">

          <!-- æŸ¥çœ‹æ¨¡å¼ -->
          <div x-show="!item.isEditing" @click="startEdit(item)"
            class="p-5 flex gap-6 cursor-pointer hover:ring-2 hover:ring-indigo-100 rounded-lg transition-all relative">
            <div class="flex-1 space-y-3">
              <div class="flex flex-wrap gap-2">
                <template x-for="q in item.questions">
                  <span
                    class="px-2 py-1 rounded text-xs border flex items-center gap-1 select-all font-medium cursor-default"
                    @click.stop
                    :class="{
                        'bg-violet-50 text-violet-700 border-violet-200': q.type === 'AI_SEMANTIC',
                        'bg-cyan-50 text-cyan-700 border-cyan-200': q.type === 'HYBRID',
                        'bg-blue-50 text-blue-700 border-blue-200': q.type === 'EXACT'
                    }">
                    <span x-text="q.question"></span>
                  </span>
                </template>
              </div>
              <div
                class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800 whitespace-pre-wrap text-sm leading-relaxed"
                x-text="item.answer" @click.stop></div>
            </div>
          </div>

          <!-- ç¼–è¾‘æ¨¡å¼ (å†…è”) -->
          <div x-show="item.isEditing" class="p-6 bg-indigo-50 border-t border-indigo-200" x-cloak>
            <div class="space-y-6">
              <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-center">å›å¤å†…å®¹ (çŸ¥è¯†åº“ç­”æ¡ˆ)</label>
                <textarea x-model="item.editBuffer.answer" rows="5" placeholder="æ”¯æŒ markdown è¯­æ³•"
                  class="w-full p-3 border rounded bg-white focus:ring-2 focus:ring-indigo-500 text-sm shadow-sm"></textarea>
              </div>
              <div>
                <div class="relative flex items-center justify-between mb-2 h-8">
                  <span class="text-xs text-gray-400 font-mono">
                     (<span x-text="item.editBuffer.questions.length"></span>/<span x-text="maxQuestions"></span>)
                  </span>
                  <label class="absolute left-1/2 -translate-x-1/2 text-xs font-bold text-gray-500 uppercase">å…³è”é—®é¢˜</label>
                  <button @click="generateQuestions(item.editBuffer)"
                    x-show="item.editBuffer.answer.trim()"
                    :disabled="item.editBuffer.questions.length >= maxQuestions || loading"
                    class="group relative text-xs bg-white border border-indigo-200 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-50 flex items-center gap-1 disabled:opacity-50 transition-colors shadow-sm">
                    <span>âœ¨</span><span
                      class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">AI ç”Ÿæˆæé—®</span>
                  </button>
                </div>

                <div class="space-y-3">
                  <template x-for="(q, qIdx) in item.editBuffer.questions" :key="qIdx">
                    <div class="flex gap-2 items-center">
                      <div x-data="{ open: false }" class="relative w-32 shrink-0" :class="open ? 'z-[100]' : 'z-10'">
                        <button @click="open = !open" @click.outside="open = false" type="button"
                          class="w-full flex justify-between items-center px-3 py-2 text-xs border rounded shadow-sm transition-colors focus:outline-none bg-white"
                          :class="{
                                'text-violet-700 border-violet-200 bg-violet-50': q.type === 'AI_SEMANTIC',
                                'text-blue-700 border-blue-200 bg-blue-50': q.type === 'EXACT',
                                'text-cyan-700 border-cyan-200 bg-cyan-50': q.type === 'HYBRID'
                            }">
                          <span x-text="q.type === 'AI_SEMANTIC' ? 'AI è¯­ä¹‰' : (q.type === 'HYBRID' ? 'æ··åˆ' : 'ç²¾ç¡®åŒ¹é…')"></span>
                          <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                        </button>
                        <div x-show="open" class="absolute top-full left-0 mt-1 w-full bg-white border border-gray-200 rounded shadow-xl overflow-hidden">
                          <div @click="q.type='AI_SEMANTIC'; open=false" class="px-3 py-2 text-xs hover:bg-violet-50 cursor-pointer text-violet-700 border-l-4 border-transparent hover:border-violet-500">AI è¯­ä¹‰</div>
                          <div @click="q.type='EXACT'; open=false" class="px-3 py-2 text-xs hover:bg-blue-50 cursor-pointer text-blue-700 border-l-4 border-transparent hover:border-blue-500">ç²¾ç¡®åŒ¹é…</div>
                          <div @click="q.type='HYBRID'; open=false" class="px-3 py-2 text-xs hover:bg-cyan-50 cursor-pointer text-cyan-700 border-l-4 border-transparent hover:border-cyan-500">æ··åˆ(è¯­ä¹‰+ç²¾ç¡®)</div>
                        </div>
                      </div>

                      <div class="relative flex-1">
                        <input type="text" x-model="q.question"
                          class="w-full p-2 pr-20 text-sm border border-gray-300 rounded shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                          placeholder="è¾“å…¥ç”¨æˆ·å¯èƒ½é—®çš„é—®é¢˜...">

                        <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1">
                          <button @click="extendQuestion(item.editBuffer, qIdx)"
                            x-show="q.question.trim()"
                            class="group relative w-7 h-7 flex items-center justify-center text-yellow-600 hover:bg-yellow-100 rounded-full transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ç”Ÿæˆç›¸ä¼¼æé—®</span>
                          </button>
                          <button @click="removeQuestion(item.editBuffer, qIdx)"
                            class="group relative w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ç§»é™¤</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <div class="relative flex justify-between items-center mt-6 border-t border-indigo-200 pt-4">
                <div>
                  <button @click="deleteItem(item.id)" :disabled="loading"
                    class="group relative w-10 h-10 flex items-center justify-center bg-red-50 text-red-600 border border-red-200 rounded-full hover:bg-red-600 hover:text-white transition shadow-sm disabled:opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">åˆ é™¤</span>
                  </button>
                </div>

                <div class="absolute left-1/2 -translate-x-1/2">
                   <button @click="addQuestion(item.editBuffer)"
                    :disabled="item.editBuffer.questions.length >= maxQuestions"
                    class="group relative w-6 h-6 self-center flex items-center justify-center bg-white border border-indigo-200 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white transition disabled:opacity-50 disabled:hover:bg-white disabled:hover:text-indigo-600">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">æ·»åŠ å…³è”é—®é¢˜</span>
                  </button>
                </div>

                <div class="flex gap-4">
                  <button @click="cancelEdit(item)"
                    class="group relative w-10 h-10 flex items-center justify-center bg-white border border-gray-200 text-gray-500 rounded-full hover:bg-gray-100 hover:text-gray-700 transition shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">å–æ¶ˆ</span>
                  </button>
                  <button @click="saveItem(item)" :disabled="loading" x-show="hasChanges(item)"
                    class="group relative w-10 h-10 flex items-center justify-center bg-green-500 text-white rounded-full hover:bg-green-600 shadow-md hover:shadow-lg transition transform hover:scale-105 disabled:opacity-50 disabled:scale-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap hidden group-hover:block z-[100] shadow-xl">ä¿å­˜</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </template>

      <div x-show="filteredItems.length === 0 && !newItem"
        class="text-center py-16 text-gray-400 bg-white rounded-lg border border-dashed border-gray-300" x-cloak>
        <div class="text-4xl mb-3">ğŸ“­</div>
        <p>æœªæ‰¾åˆ°åŒ¹é…çš„çŸ¥è¯†åº“æ¡ç›®</p>
        <p class="text-sm mt-2">å°è¯•å…¶ä»–å…³é”®è¯ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’æ–°å¢</p>
      </div>
    </div>

    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0 -translate-y-4"
      class="fixed top-6 left-1/2 -translate-x-1/2 z-[200] flex items-center gap-2 px-5 py-3 text-sm font-medium text-white bg-gray-800 rounded-lg shadow-2xl"
      x-cloak>
      <span>ğŸ””</span>
      <span x-text="toast.msg"></span>
    </div>

  </div>

  <script>
    function kbApp() {
      return {
        allItems: [], searchQuery: '', page: 1, pageSize: 10, loading: false, newItem: null, maxQuestions: 20,
        toast: { show: false, msg: '' },

        async request(url, method = 'GET', body = null) {
          this.loading = true;
          try {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(url, opts);
            const json = await res.json();
            if (json.code !== 0) throw new Error(json.message);
            return json.data;
          } catch (e) {
            this.showToast(e.message || 'è¯·æ±‚å¤±è´¥');
            throw e;
          } finally {
            this.loading = false;
          }
        },

        async initData() {
          try {
            const data = await this.request('/api/v1/admin/keywords');
            this.allItems = (data || []).map(item => ({
              ...item, isEditing: false, editBuffer: this.createBuffer(item.answer, item.questions)
            }));
          } catch (e) { }
        },

        createBuffer(answer = '', questions = []) {
          return { answer, questions: questions.length ? JSON.parse(JSON.stringify(questions)) : [{ question: '', type: 'AI_SEMANTIC' }] };
        },

        async handleGen(buffer, payload, insertIdx = -1) {
          try {
            const data = await this.request('/api/v1/admin/keywords/generate-questions', 'POST', payload);
            const newQs = (data.questions || []).filter(q => !buffer.questions.some(e => e.question === q));

            const remaining = this.maxQuestions - buffer.questions.length;
            if (newQs.length > remaining) newQs.length = remaining;

            if (newQs.length === 0) return this.showToast('æœªç”Ÿæˆæ–°é—®é¢˜æˆ–å·²å­˜åœ¨');

            const formatted = newQs.map(q => ({ question: q, type: 'AI_SEMANTIC' }));

            if (insertIdx >= 0) {
              buffer.questions.splice(insertIdx + 1, 0, ...formatted);
            } else {
              if (buffer.questions.length === 1 && !buffer.questions[0].question.trim()) {
                buffer.questions = formatted;
              } else {
                buffer.questions.push(...formatted);
              }
            }

            this.showToast(`å·²æ·»åŠ  ${newQs.length} ä¸ªé—®é¢˜`);
          } catch (e) { }
        },

        generateQuestions(buffer) {
          if (!buffer.answer) return this.showToast('è¯·å…ˆè¾“å…¥ç­”æ¡ˆ');
          this.handleGen(buffer, { context: buffer.answer, type: 'content' });
        },

        extendQuestion(buffer, idx) {
          const seed = buffer.questions[idx].question;
          if (!seed) return this.showToast('è¯·è¾“å…¥ç§å­é—®é¢˜');
          this.handleGen(buffer, { context: seed, type: 'keyword' }, idx);
        },

        async saveItem(item) {
          const buf = item.editBuffer;
          if (!buf.answer.trim()) return this.showToast('ç­”æ¡ˆä¸èƒ½ä¸ºç©º');
          if (buf.questions.some(q => !q.question.trim())) return this.showToast('é—®é¢˜ä¸èƒ½ä¸ºç©º');

          if (item.id) {
            const original = JSON.stringify({ answer: item.answer, questions: item.questions });
            const current = JSON.stringify({ answer: buf.answer, questions: buf.questions });
            if (original === current) {
              this.showToast('æœªä¿®æ”¹ä»»ä½•å†…å®¹');
              item.isEditing = false;
              return;
            }
          }

          try {
            await this.request('/api/v1/admin/keywords', 'POST', { id: item.id, answer: buf.answer, questions: buf.questions });
            this.showToast('ä¿å­˜æˆåŠŸ');
            this.newItem = null;
            await this.initData();
          } catch (e) { }
        },

        async deleteItem(id) {
          if (!confirm('ç¡®å®šåˆ é™¤?')) return;
          try {
            await this.request(`/api/v1/admin/keywords/${id}`, 'DELETE');
            this.showToast('å·²åˆ é™¤');
            await this.initData();
          } catch (e) { }
        },

        async forceSync() {
          if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ç«‹å³ç”Ÿæ•ˆå—ï¼Ÿ')) return;
          try {
            await this.request('/api/v1/admin/keywords/force-sync', 'POST');
            this.showToast('åŒæ­¥ä»»åŠ¡å·²è§¦å‘');
          } catch (e) { }
        },

        createNew() {
          if (this.isEditingMode) return this.showToast('è¯·å…ˆå¤„ç† ç¼–è¾‘é¡¹');
          if (!this.newItem) { this.newItem = { id: '', isEditing: true, editBuffer: this.createBuffer() }; window.scrollTo({ top: 0, behavior: 'smooth' }); }
        },
        startEdit(item) {
          if (this.isEditingMode) return this.showToast('è¯·å…ˆå¤„ç† ç¼–è¾‘é¡¹');
          this.allItems.forEach(i => i.isEditing = false);
          this.newItem = null;
          item.editBuffer = this.createBuffer(item.answer, item.questions);
          item.isEditing = true;
        },

        cancelEdit(item) {
          if (this.hasChanges(item)) {
            if (!confirm('æ£€æµ‹åˆ°æœªä¿å­˜çš„ä¿®æ”¹, ç¡®å®šå–æ¶ˆå—?')) return;
          }
          if (!item.id) this.newItem = null; else item.isEditing = false;
        },

        hasChanges(item) {
          const buf = item.editBuffer;
          if (!item.id) {
             const hasAnswer = buf.answer && buf.answer.trim().length > 0;
             const hasQs = buf.questions.length > 1 || (buf.questions[0] && (buf.questions[0].question.trim() !== '' || buf.questions[0].type !== 'AI_SEMANTIC'));
             return hasAnswer || hasQs;
          }
          const original = JSON.stringify({ answer: item.answer, questions: item.questions });
          const current = JSON.stringify({ answer: buf.answer, questions: buf.questions });
          return original !== current;
        },

        addQuestion(buf) { if (buf.questions.length < this.maxQuestions) buf.questions.push({ question: '', type: 'AI_SEMANTIC' }); },
        removeQuestion(buf, idx) { if (buf.questions.length > 1) buf.questions.splice(idx, 1); },

        get filteredItems() {
          if (!this.searchQuery) return this.allItems;
          const q = this.searchQuery.toLowerCase();
          return this.allItems.filter(i => i.answer.toLowerCase().includes(q) || i.questions.some(sq => sq.question.toLowerCase().includes(q)));
        },
        get totalPages() { return Math.ceil(this.filteredItems.length / this.pageSize) || 1; },
        get pagedItems() { const s = (this.page - 1) * this.pageSize; return this.filteredItems.slice(s, s + this.pageSize); },
        prevPage() { if (this.page > 1) this.page--; },
        nextPage() { if (this.page < this.totalPages) this.page++; },
        showToast(msg) { this.toast.msg = msg; this.toast.show = true; setTimeout(() => this.toast.show = false, 3000); },

        get isEditingMode() { return !!this.newItem || this.allItems.some(item => item.isEditing); }
      }
    }
  </script>
</body>

</html>
